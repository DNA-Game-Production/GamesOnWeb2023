{"version":3,"file":"avatar.js","names":["Animation","Axis","Color3","MeshBuilder","Quaternion","StandardMaterial","Vector3","Ray","serverMessages","ws","Bullet","inputStates","MeshWithHealth","createLabel","sphere1","Avatar","counter","constructor","scene","avatar_username","username","p","health","name","sphere","CreateCylinder","diameter","height","queue","CreateSphere","segments","ellipsoid","checkCollisions","myMaterial","diffuseColor","material","parent","addChild","position","bulletList","speed_coeff","didSomething","plane","oldPosition","clone","ray","jumpRay","isJumping","canJump","timeJumping","bulletDelay","onCollide","e","avatar","includes","healthMinus","direction","subtract","knockback","move","goRight","goLeft","goBackward","goForeward","rotateRight","rotateLeft","attack","getDirection","Z","coeff_diagonal","Math","PI","moveWithCollisions","scale","applyRotationQuaternion","FromEulerAngles","BABYLON","Tools","ToRadians","rotate","Y","addBullet","send","JSON","stringify","route","FIRE_BULLET","content","jump","setTimeout","displayOnly","lastShoot","undefined","Date","now","push","updateBulletPosition","forEach","update","dispose","power","targetPosition","add","CreateAndStartAnimation","ANIMATIONLOOPMODE_CONSTANT","origin","addAvatar"],"sources":["../../../../src/clients/babylon/avatars/avatar.ts"],"sourcesContent":["import { Animation, Axis, Color3, Mesh, MeshBuilder, Quaternion, Scene, StandardMaterial, Vector3, Ray } from \"babylonjs\";\r\nimport { serverMessages, ws } from \"../../connectionWS\";\r\nimport { Bullet } from \"../bullet\";\r\nimport { inputStates } from \"../inputListeners\";\r\nimport { Health, MeshWithHealth } from \"../meshWithHealth\";\r\nimport { createLabel } from \"../tools\";\r\nimport { sphere1 } from \"../main\";\r\n\r\nexport class Avatar extends MeshWithHealth {\r\n  static counter = 0;\r\n  counter: number;\r\n  sphere: Mesh;\r\n  bulletList: Bullet[];\r\n  speed_coeff: number;\r\n  didSomething: Boolean;\r\n  oldPosition: Vector3;\r\n  isJumping: boolean;\r\n  canJump: boolean;\r\n  timeJumping: number;\r\n  bulletDelay: number;\r\n  lastShoot?: number;\r\n  ray: Ray;\r\n  jumpRay: Ray\r\n\r\n\r\n  constructor(scene: Scene, avatar_username: string, username: string, p?: { bulletDelay?: number, health?: Health }) {\r\n    super(avatar_username + Avatar.counter, scene, p?.health);\r\n    this.name = avatar_username\r\n    this.counter = Avatar.counter;\r\n    Avatar.counter += 3;\r\n    let sphere = MeshBuilder.CreateCylinder(this.name + \"sp1\", { diameter: 0.5, height: 2 }, scene);\r\n    let queue = MeshBuilder.CreateSphere(this.name + \"sp2\", { segments: 16, diameter: 0.3 }, scene);\r\n\r\n    this.ellipsoid = new Vector3(0.5, 1, 0.5);\r\n    this.checkCollisions = true;\r\n    if (avatar_username !== username) {\r\n      sphere.checkCollisions = true;\r\n    }\r\n    var myMaterial = new StandardMaterial(\"myMaterial\", scene);\r\n\r\n    myMaterial.diffuseColor = new Color3(0.3, 0.5, 1);\r\n    sphere.material = myMaterial;\r\n\r\n    sphere.parent = this;\r\n    this.addChild(sphere)\r\n    this.addChild(queue)\r\n    queue.position = new Vector3(0, 0, -0.3);\r\n    this.sphere = sphere;\r\n    this.bulletList = [];\r\n    this.speed_coeff = 0.20;\r\n    this.didSomething = false;\r\n\r\n    // let plane = createTextOnPlane(this.avatar_username, scene)\r\n    // this.addChild(plane)\r\n    let plane = createLabel(this.name, this);\r\n    this.addChild(plane)\r\n\r\n\r\n    this.position = new Vector3(this.counter, 2, 0);\r\n    this.oldPosition = this.position.clone();\r\n\r\n\r\n    this.ray = new Ray(this.position, new Vector3(0, -1, 0), 1.2);\r\n    this.jumpRay = new Ray(this.position, new Vector3(0, 1, 0), 1.2);\r\n\r\n    this.isJumping = false;\r\n    this.canJump = true;\r\n    this.timeJumping = 500;\r\n    this.bulletDelay = p?.bulletDelay || 500;\r\n\r\n    this.onCollide = e => {\r\n      if (e?.parent instanceof Avatar) {\r\n        let avatar = e.parent as Avatar;\r\n        if (avatar.name.includes(\"zombie\") && this?.name === sphere1!.name) {\r\n          this.healthMinus(5)\r\n          let direction = this.position.subtract(avatar.position)\r\n          this.knockback(direction, 2)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  move() {\r\n\r\n    if (inputStates.goRight || inputStates.goLeft || inputStates.goBackward || inputStates.goForeward || inputStates.rotateRight || inputStates.rotateLeft || inputStates.attack)\r\n      this.didSomething = true;\r\n\r\n    let direction = this.getDirection(Axis.Z)\r\n\r\n    let coeff_diagonal = 1\r\n    if ((inputStates.goForeward || inputStates.goBackward) && (inputStates.goLeft || inputStates.goRight)) coeff_diagonal = Math.PI / 4;\r\n\r\n    //forward/backward movement\r\n    if (inputStates.goForeward) {\r\n      this.moveWithCollisions(direction.scale(this.speed_coeff * coeff_diagonal));\r\n    } else if (inputStates.goBackward) {\r\n      this.moveWithCollisions(direction.scale(-this.speed_coeff * coeff_diagonal / 2));\r\n    }\r\n\r\n    //left/right movement\r\n    if (inputStates.goLeft) {\r\n      direction = direction.applyRotationQuaternion(Quaternion.FromEulerAngles(0, BABYLON.Tools.ToRadians(90), 0));\r\n      this.moveWithCollisions(direction.scale(-this.speed_coeff * coeff_diagonal / 1.5));\r\n    } else if (inputStates.goRight) {\r\n      direction = direction.applyRotationQuaternion(Quaternion.FromEulerAngles(0, BABYLON.Tools.ToRadians(90), 0));\r\n      this.moveWithCollisions(direction.scale(this.speed_coeff * coeff_diagonal / 1.5));\r\n    }\r\n\r\n    //player rotation\r\n    if (inputStates.rotateRight) {\r\n      this.rotate(Axis.Y, +0.05)\r\n    } else if (inputStates.rotateLeft) {\r\n      this.rotate(Axis.Y, -0.05)\r\n    }\r\n\r\n    //player's main attack\r\n    if (inputStates.attack) {\r\n      this.addBullet()\r\n      ws.send(\r\n        JSON.stringify({\r\n          route: serverMessages.FIRE_BULLET,\r\n          content: this.name\r\n        }))\r\n\r\n    }\r\n\r\n    //jump\r\n    if (inputStates.jump) {\r\n      if (this.canJump) {\r\n        this.isJumping = true;\r\n        this.canJump = false\r\n        setTimeout(() => {\r\n          this.isJumping = false\r\n        }, this.timeJumping / 2.5)\r\n        setTimeout(() => {\r\n          this.canJump = true\r\n        }, this.timeJumping)\r\n      }\r\n    }\r\n  }\r\n\r\n  addBullet(displayOnly = false) {\r\n    if (this.lastShoot === undefined || this.lastShoot + this.bulletDelay < Date.now()) {\r\n      this.lastShoot = Date.now()\r\n      this.bulletList.push(new Bullet(this, displayOnly))\r\n    }\r\n  }\r\n\r\n  updateBulletPosition() {\r\n    this.bulletList.forEach(e => e.update())\r\n  }\r\n\r\n  dispose(): void {\r\n    super.dispose()\r\n  }\r\n\r\n  knockback(direction: Vector3, power: number) {\r\n    let targetPosition = this.position.add(direction.scale(power))\r\n    Animation.CreateAndStartAnimation(\"animMove\", this, \"position\", 60, 12, this.position, targetPosition, Animation.ANIMATIONLOOPMODE_CONSTANT, undefined,\r\n      () => {\r\n        this.ray.origin = this.position\r\n        this.jumpRay.origin = this.position\r\n      })\r\n  };\r\n\r\n}\r\n\r\nexport function addAvatar(scene: Scene, avatar_username: string) {\r\n  return new Avatar(scene, avatar_username, \"\")\r\n}"],"mappings":"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"}